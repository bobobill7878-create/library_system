<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–æ›¸ç®¡ç†ç³»çµ±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f9f9f9; }
        .container { max-width: 1200px; margin: 0 auto; }
        .search-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .search-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background-color: #f8f9fa; cursor: pointer; min-width: 100px; }
        .search-input { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; min-width: 200px; }
        .btn-search { padding: 10px 25px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-reset { padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;}
        .filter-section { display: flex; flex-wrap: wrap; gap: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-title { font-weight: bold; margin-bottom: 8px; color: #555; font-size: 14px; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .checkbox-label { display: flex; align-items: center; gap: 5px; font-size: 14px; color: #333; cursor: pointer; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .book-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; display: flex; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s; cursor: pointer; }
        .book-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .book-cover { width: 80px; height: 110px; flex-shrink: 0; background-color: #eee; border-radius: 4px; overflow: hidden; }
        .book-cover img { width: 100%; height: 100%; object-fit: cover; }
        .book-info { flex-grow: 1; overflow: hidden; }
        .book-title { margin: 0 0 5px 0; font-size: 18px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-meta { font-size: 13px; color: #666; margin-bottom: 3px; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: white; margin-top: 5px; }
        .status-æœªè®€ { background-color: #dc3545; }
        .status-é–±è®€ä¸­ { background-color: #17a2b8; }
        .status-å·²è®€å®Œ { background-color: #28a745; }
        .status-æ£„å‘ { background-color: #6c757d; }
        .action-links { margin-top: 10px; font-size: 13px; position: relative; z-index: 2; }
        .action-links a { margin-right: 10px; text-decoration: none; color: #007bff; }
        .action-links a.delete-btn { color: #dc3545; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .add-btn { background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: bold; }
        .btn-tool { padding: 10px 15px; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; font-size: 14px; display: flex; align-items: center; }
        .btn-tool:hover { opacity: 0.9; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 10px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        .modal-body { display: flex; gap: 20px; margin-top: 10px; }
        .modal-cover { width: 150px; flex-shrink: 0; }
        .modal-cover img { width: 100%; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .modal-details { flex-grow: 1; }
        .modal-label { font-weight: bold; color: #333; display: inline-block; width: 70px; }
        @media (max-width: 600px) { .modal-body { flex-direction: column; align-items: center; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š æˆ‘çš„åœ–æ›¸é¤¨</h1>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <a href="{{ url_for('manage_categories') }}" class="btn-tool" style="background-color: #6f42c1;">ğŸ·ï¸ åˆ†é¡ç®¡ç†</a>
                <a href="{{ url_for('export_excel') }}" class="btn-tool" style="background-color: #17a2b8;">ğŸ“¤ åŒ¯å‡º</a>
                <form action="{{ url_for('import_excel') }}" method="POST" enctype="multipart/form-data" style="display: inline;">
                    <input type="file" name="file" id="importFile" style="display: none;" accept=".xlsx, .xls" onchange="this.form.submit()">
                    <button type="button" class="btn-tool" style="background-color: #ffc107; color: black;" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥</button>
                </form>
                <a href="{{ url_for('add_book') }}" class="add-btn">â• æ–°å¢æ›¸ç±</a>
            </div>
        </div>

        <form method="GET" action="/" class="search-box">
            <div class="search-row">
                <select name="search_type" class="search-select">
                    <option value="all" {% if search_type == 'all' %}selected{% endif %}>å…¨éƒ¨æ¬„ä½</option>
                    <option value="title" {% if search_type == 'title' %}selected{% endif %}>æ›¸å</option>
                    <option value="author" {% if search_type == 'author' %}selected{% endif %}>ä½œè€…</option>
                    <option value="publisher" {% if search_type == 'publisher' %}selected{% endif %}>å‡ºç‰ˆç¤¾</option>
                    <option value="isbn" {% if search_type == 'isbn' %}selected{% endif %}>ISBN</option>
                </select>
                <input type="text" name="q" class="search-input" placeholder="è¼¸å…¥é—œéµå­—..." value="{{ q }}">
                <button type="submit" class="btn-search">ğŸ” æœå°‹</button>
                <a href="/" class="btn-reset">æ¸…é™¤</a>
            </div>

            <div class="filter-section">
                <div class="filter-group">
                    <div class="filter-title">ğŸ“‚ åˆ†é¡</div>
                    <div class="checkbox-grid">
                        {% for cat in categories %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="category" value="{{ cat.id }}" {% if cat.id|string in selected_cats %}checked{% endif %}>
                            {{ cat.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-title">ğŸ“– ç‹€æ…‹</div>
                    <div class="checkbox-grid">
                        {% for status in ['æœªè®€', 'é–±è®€ä¸­', 'å·²è®€å®Œ', 'æ£„å‘'] %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="status" value="{{ status }}" {% if status in selected_status %}checked{% endif %}>
                            {{ status }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>

        <div class="book-grid">
            {% for book in books %}
            <div class="book-card" onclick="openModal(this)"
                 data-title="{{ book.title }}"
                 data-author="{{ book.author }}"
                 data-publisher="{{ book.publisher or 'æœªçŸ¥' }}"
                 data-isbn="{{ book.isbn or 'ç„¡' }}"
                 data-category="{{ book.category.name if book.category else 'æœªåˆ†é¡' }}"
                 data-status="{{ book.status }}"
                 data-rating="{{ book.rating }}"
                 data-version="{{ book.print_version or '' }}" 
                 data-cover="{{ book.cover_url or '' }}"
                 data-desc="{{ book.description or 'æš«ç„¡ç°¡ä»‹' }}"
                 data-notes="{{ book.notes or 'ç„¡å‚™è¨»' }}"
                 data-year="{{ book.publish_year or '' }}"
                 data-location="{{ book.location or 'æœªè¨­å®š' }}">
                 
                <div class="book-cover">
                    {% if book.cover_url %}
                    <img src="{{ book.cover_url }}" alt="å°é¢">
                    {% else %}
                    <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#ccc;">ç„¡å°é¢</div>
                    {% endif %}
                </div>
                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                    <div class="book-meta">âœï¸ {{ book.author }}</div>
                    <div class="book-meta">ğŸ“‚ {{ book.category.name if book.category else 'æœªåˆ†é¡' }}</div>
                    <span class="status-badge status-{{ book.status }}">{{ book.status }}</span>
                    {% if book.rating > 0 %}<span style="color: gold;">{{ 'â­' * book.rating }}</span>{% endif %}
                    
                    <div class="action-links">
                        <a href="{{ url_for('edit_book', id=book.id) }}" onclick="event.stopPropagation()">ç·¨è¼¯</a>
                        <a href="{{ url_for('delete_book', id=book.id) }}" class="delete-btn" onclick="event.stopPropagation(); return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')">åˆªé™¤</a>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="grid-column: 1 / -1; text-align: center; color: #888; margin-top: 50px;"><h3>ğŸ“­ æ‰¾ä¸åˆ°æ›¸ç±</h3></div>
            {% endfor %}
        </div>
    </div>

    <div id="bookModal" class="modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div class="modal-body">
                <div class="modal-cover">
                    <img id="m-cover" src="" alt="å°é¢" style="display:none;">
                    <div id="m-no-cover" style="width:100%; height:200px; background:#eee; display:flex; align-items:center; justify-content:center; color:#999; border-radius:6px;">ç„¡å°é¢</div>
                </div>
                <div class="modal-details">
                    <h2 id="m-title"></h2>
                    <p><span class="modal-label">ä½œè€…:</span> <span id="m-author"></span></p>
                    <p><span class="modal-label">å‡ºç‰ˆç¤¾:</span> <span id="m-publisher"></span></p>
                    <p><span class="modal-label">ç‰ˆæœ¬:</span> <span id="m-version" style="color: #d63384; font-weight: bold;"></span></p>
                    <p><span class="modal-label">ç‹€æ…‹:</span> <span id="m-status"></span></p>
                    <p><span class="modal-label">ISBN:</span> <span id="m-isbn"></span></p>
                    <p><span class="modal-label">ä½ç½®:</span> <span id="m-location"></span></p>
                    <p><span class="modal-label">è©•åˆ†:</span> <span id="m-rating" style="color:gold;"></span></p>
                    <hr>
                    <p><strong>ğŸ“ ç°¡ä»‹:</strong><br><span id="m-desc"></span></p>
                    <p><strong>ğŸ“Œ å‚™è¨»/ç­†è¨˜:</strong><br><span id="m-notes"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openModal(card) {
            document.getElementById('m-title').textContent = card.dataset.title;
            document.getElementById('m-author').textContent = card.dataset.author;
            document.getElementById('m-publisher').textContent = card.dataset.publisher + (card.dataset.year ? ` (${card.dataset.year})` : '');
            document.getElementById('m-status').textContent = card.dataset.status;
            document.getElementById('m-isbn').textContent = card.dataset.isbn;
            document.getElementById('m-location').textContent = card.dataset.location;
            document.getElementById('m-desc').textContent = card.dataset.desc;
            document.getElementById('m-notes').textContent = card.dataset.notes;
            
            const ver = card.dataset.version;
            const verEl = document.getElementById('m-version');
            if(ver) { verEl.textContent = ver; verEl.parentElement.style.display='block'; }
            else { verEl.parentElement.style.display='none'; }

            const rating = parseInt(card.dataset.rating) || 0;
            document.getElementById('m-rating').textContent = 'â­'.repeat(rating);

            const coverUrl = card.dataset.cover;
            const imgEl = document.getElementById('m-cover');
            const noImgEl = document.getElementById('m-no-cover');
            
            if (coverUrl && coverUrl !== 'None') {
                imgEl.src = coverUrl; imgEl.style.display = 'block'; noImgEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none'; noImgEl.style.display = 'flex';
            }
            document.getElementById('bookModal').style.display = "block";
        }
        function closeModal() { document.getElementById('bookModal').style.display = "none"; }
    </script>
</body>
</html>
