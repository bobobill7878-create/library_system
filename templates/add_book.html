<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢åœ–æ›¸</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; display: flex; flex-direction: column; align-items: center; background-color: #f9f9f9; }
        form { max-width: 650px; width: 100%; padding: 30px; border: 1px solid #ddd; border-radius: 12px; background-color: #fff; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .row { display: flex; gap: 15px; } .row > div { flex: 1; }
        .cover-preview { display: none; margin: 10px auto; width: 150px; text-align: center; }
        .cover-preview img { width: 100%; border: 1px solid #ddd; }
        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; }
        .btn-scan { background-color: #17a2b8; margin-bottom: 15px; }
        .btn-submit { background-color: #28a745; width: 100%; font-size: 16px; }
        .message-box { color: #dc3545; margin: 10px 0; }
        #reader-container { display: none; margin-bottom: 15px; border: 2px dashed #007bff; padding: 10px; }
    </style>
</head>
<body>
    <h1>â• æ–°å¢åœ–æ›¸</h1>
    <form method="POST" enctype="multipart/form-data">
        
        <div id="reader-container"><div id="reader"></div><button type="button" onclick="stopScanner()">é—œé–‰é¡é ­</button></div>
        
        <label>ISBN:</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="isbn" name="isbn" placeholder="è¼¸å…¥ ISBN å¾ŒæŒ‰ Enter" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupBookData();}">
            <button type="button" class="btn btn-scan" onclick="startScanner()">ğŸ“· æƒæ</button>
            <button type="button" class="btn btn-scan" style="background:#007bff" onclick="lookupBookData()">æŸ¥è©¢</button>
        </div>
        <div id="isbn-message" class="message-box"></div>

        <label>å°é¢ç¶²å€ (æˆ–ä¸‹æ–¹ä¸Šå‚³æª”æ¡ˆ):</label>
        <input type="text" id="cover_url" name="cover_url" placeholder="åœ–ç‰‡ç¶²å€..." oninput="updateCoverPreview()">
        <div id="cover-preview" class="cover-preview"><img id="book-cover-img" src=""></div>

        <label>æ›¸å *:</label> <input type="text" id="title" name="title" required>
        <div class="row">
            <div><label>ä½œè€… *:</label><input type="text" id="author" name="author" required></div>
            <div><label>å‡ºç‰ˆç¤¾:</label><input type="text" id="publisher" name="publisher"></div>
        </div>
        <div class="row">
            <div><label>åˆ†é¡:</label>
                <select name="category">
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
                </select>
            </div>
            <div><label>ç‹€æ…‹:</label>
                <select name="status">
                    <option value="æœªè®€">æœªè®€</option>
                    <option value="é–±è®€ä¸­">é–±è®€ä¸­</option>
                    <option value="å·²è®€å®Œ">å·²è®€å®Œ</option>
                    <option value="æ£„å‘">æ£„å‘</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div><label>å‡ºç‰ˆå¹´:</label><input type="number" id="year" name="year"></div>
            <div><label>å‡ºç‰ˆæœˆ:</label><input type="number" id="month" name="month"></div>
        </div>
        
        <label>ä¸Šå‚³å°é¢æª”æ¡ˆ (é¸å¡«):</label>
        <input type="file" name="cover_file" accept="image/*">

        <label>å¤§ç¶±:</label><textarea id="description" name="description" rows="3"></textarea>
        
        <button type="submit" class="btn btn-submit">å„²å­˜</button>
    </form>

    <script>
        let html5QrCode;
        function startScanner() {
            document.getElementById('reader-container').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                document.getElementById('isbn').value = txt; stopScanner(); lookupBookData();
            });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop(); document.getElementById('reader-container').style.display = 'none'; }
        
        function updateCoverPreview() {
            const url = document.getElementById('cover_url').value;
            const div = document.getElementById('cover-preview');
            if(url){ document.getElementById('book-cover-img').src = url; div.style.display='block'; } else { div.style.display='none'; }
        }

        function lookupBookData() {
            const isbn = document.getElementById('isbn').value.replace(/-/g,'');
            const msg = document.getElementById('isbn-message');
            msg.textContent = "æœå°‹ä¸­...";
            fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`).then(r=>r.json()).then(data=>{
                if(data.totalItems>0){
                    const v = data.items[0].volumeInfo;
                    document.getElementById('title').value = v.title;
                    document.getElementById('author').value = v.authors ? v.authors.join(', ') : '';
                    document.getElementById('publisher').value = v.publisher || '';
                    if(v.publishedDate) document.getElementById('year').value = v.publishedDate.split('-')[0];
                    if(v.description) document.getElementById('description').value = v.description;
                    if(v.imageLinks){
                        let img = v.imageLinks.thumbnail || v.imageLinks.smallThumbnail;
                        document.getElementById('cover_url').value = img.replace('http://','https://');
                        updateCoverPreview();
                    }
                    msg.textContent = "æœå°‹æˆåŠŸï¼"; msg.style.color="green";
                } else { msg.textContent = "Google æ‰¾ä¸åˆ°æ­¤æ›¸ï¼Œè«‹å˜—è©¦ OpenLibrary æˆ–æ‰‹å‹•è¼¸å…¥ã€‚"; }
            });
        }
    </script>
</body>
</html>
