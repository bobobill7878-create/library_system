<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢æ›¸ç±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        .preview-img { max-width: 150px; max-height: 200px; object-fit: cover; border: 1px solid #ddd; margin-top: 10px; display: none; }
        .scanner-box { width: 100%; max-width: 400px; margin: 0 auto; display: none; }
        .external-links a { margin-right: 10px; text-decoration: none; }
        #api-message { font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“– æ–°å¢æ›¸ç±</h2>
            <a href="/" class="btn btn-secondary">å›é¦–é </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div id="reader-container" class="scanner-box mb-3">
                    <div id="reader"></div>
                    <button type="button" class="btn btn-danger w-100 mt-2" onclick="stopScanner()">é—œé–‰é¡é ­</button>
                </div>

                <form id="addBookForm" onsubmit="submitForm(event)">
                    
                    <div class="row g-2 mb-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">ISBN (åœ‹éš›æ›¸è™Ÿ)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="isbn" id="isbn" placeholder="æƒææˆ–è¼¸å…¥..." onkeypress="handleEnter(event, 'isbn')">
                                <button type="button" class="btn btn-outline-primary" onclick="startScanner()">ğŸ“·</button>
                                <button type="button" class="btn btn-primary" onclick="lookupBookData('isbn')">ğŸ”</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">æ›¸å <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="title" id="title" required onkeypress="handleEnter(event, 'title')">
                                <button type="button" class="btn btn-outline-secondary" onclick="lookupBookData('title')">æœæ›¸å</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <small id="api-message"></small>
                        </div>
                    </div>
                    
                    <div class="mb-3 external-links" id="link-container" style="display:none;">
                        <small class="text-muted">å¿«é€ŸæŸ¥è©¢ï¼š</small>
                        <a href="#" target="_blank" id="link-books" class="badge bg-success">åšå®¢ä¾†</a>
                        <a href="#" target="_blank" id="link-momo" class="badge bg-danger">Momo</a>
                        <a href="#" target="_blank" id="link-taaze" class="badge bg-warning text-dark">è®€å†Š</a>
                        <a href="#" target="_blank" id="link-google" class="badge bg-info text-dark">Google</a>
                    </div>

                    <hr>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">ä½œè€…</label>
                            <input type="text" class="form-control" name="author" id="author">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å‡ºç‰ˆç¤¾</label>
                            <input type="text" class="form-control" name="publisher" id="publisher">
                        </div>
                    </div>

                    <button class="btn btn-sm btn-outline-secondary mb-3 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedInfo">
                        ğŸ”½ é¡¯ç¤º/éš±è— è©³ç´°è³‡æ–™
                    </button>
                    
                    <div class="collapse show" id="advancedInfo">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">åˆ†é¡</label>
                                <select class="form-select" name="category_id" id="category_id">
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control mt-2" name="new_category" placeholder="æˆ–æ–°å¢åˆ†é¡..." style="font-size: 0.9em;">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ç³»åˆ—/é›†æ•¸</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="series" placeholder="ç³»åˆ—å">
                                    <input type="text" class="form-control" name="volume" placeholder="Vol." style="max-width: 80px;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">é–±è®€ç‹€æ…‹</label>
                                <select class="form-select" name="status" id="status">
                                    <option value="æœªè®€">ğŸ”´ æœªè®€</option>
                                    <option value="é–±è®€ä¸­">ğŸŸ¡ é–±è®€ä¸­</option>
                                    <option value="å·²è®€">ğŸŸ¢ å·²è®€</option>
                                    <option value="æ£„æ›¸">âš« æ£„æ›¸</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">å‡ºç‰ˆæ—¥æœŸ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="publish_year" id="year" placeholder="å¹´">
                                    <input type="number" class="form-control" name="publish_month" id="month" placeholder="æœˆ">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ç‰ˆæœ¬</label>
                                <select class="form-select" name="print_version" id="print_version">
                                    <option value="">--é¸æ“‡--</option>
                                    <option value="å¹³è£">å¹³è£</option>
                                    <option value="ç²¾è£">ç²¾è£</option>
                                    <option value="é›»å­æ›¸">é›»å­æ›¸</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è©•åˆ† (1-5)</label>
                                <input type="number" class="form-control" name="rating" min="1" max="5">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ç°¡ä»‹</label>
                            <textarea class="form-control" name="description" id="description" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="mb-3 p-3 bg-white border rounded">
                        <label class="form-label fw-bold">å°é¢åœ–ç‰‡</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">ç¶²å€</span>
                            <input type="text" class="form-control" name="cover_url" id="cover_url" placeholder="https://..." onchange="updatePreviewFromUrl()">
                        </div>
                        <div id="cover-preview" class="preview-img text-center">
                            <img id="book-cover-img" src="" alt="å°é¢é è¦½" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" id="submit-btn" class="btn btn-primary btn-lg">ğŸ’¾ å„²å­˜æ›¸ç±</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function submitForm(event) {
            event.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ å„²å­˜ä¸­..."; btn.disabled = true;

            fetch('/add', { method: 'POST', body: new FormData(event.target) })
            .then(r => {
                if (r.ok) {
                    alert('âœ… æ–°å¢æˆåŠŸï¼è«‹ç¹¼çºŒä¸‹ä¸€æœ¬ã€‚');
                    resetFormPartial();
                    document.getElementById('isbn').focus();
                } else { alert('âŒ æ–°å¢å¤±æ•—'); }
            })
            .catch(e => alert('âŒ éŒ¯èª¤'))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        function resetFormPartial() {
            ['isbn','title','author','publisher','year','month','description','cover_url'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('status').value = 'æœªè®€';
            document.getElementById('print_version').value = '';
            document.getElementById('link-container').style.display = 'none';
            document.getElementById('cover-preview').style.display = 'none';
            document.getElementById('book-cover-img').src = '';
            document.getElementById('api-message').textContent = '';
        }

        function updateExternalLinks() {
            const k = document.getElementById('isbn').value.trim() || document.getElementById('title').value.trim();
            const c = document.getElementById('link-container');
            if(k) {
                c.style.display = 'block';
                document.getElementById('link-books').href = `https://search.books.com.tw/search/query/key/${k}`;
                document.getElementById('link-momo').href = `https://m.momoshop.com.tw/search.momo?searchKeyword=${k}`;
                document.getElementById('link-taaze').href = `https://www.taaze.tw/rwd_search_result.html?keyType%5B%5D=0&keyword%5B%5D=${k}`;
                document.getElementById('link-google').href = `https://www.google.com/search?q=${k}`;
            } else { c.style.display = 'none'; }
        }

        // â˜…â˜…â˜… æ ¸å¿ƒï¼šå…ˆæ‰¾åšå®¢ä¾†ï¼Œå¤±æ•—æ‰¾ Google â˜…â˜…â˜…
        function lookupBookData(type) {
            let key = type === 'isbn' ? document.getElementById('isbn').value : document.getElementById('title').value;
            if(!key) { alert("è«‹è¼¸å…¥å…§å®¹"); return; }
            
            const msg = document.getElementById('api-message');
            msg.textContent = "ğŸ¢ çˆ¬èŸ²å‰å¾€åšå®¢ä¾†æœå°‹ä¸­...è«‹ç¨å€™";
            msg.style.color = "blue";
            
            // å‘¼å«æˆ‘å€‘è‡ªå·±çš„å¾Œç«¯ (app.py)
            fetch(`/api/lookup_books_tw?q=${encodeURIComponent(key)}`)
            .then(r => r.json())
            .then(resp => {
                if(resp.success) {
                    const data = resp.data;
                    if(data.title) document.getElementById('title').value = data.title;
                    if(data.author) document.getElementById('author').value = data.author;
                    if(data.publisher) document.getElementById('publisher').value = data.publisher;
                    if(data.year) document.getElementById('year').value = data.year;
                    if(data.month) document.getElementById('month').value = data.month;
                    if(data.description) document.getElementById('description').value = data.description;
                    if(data.cover_url) {
                        document.getElementById('cover_url').value = data.cover_url;
                        updatePreviewFromUrl();
                    }
                    msg.textContent = "âœ… æˆåŠŸå¾åšå®¢ä¾†æŠ“å–è³‡æ–™ï¼";
                    msg.style.color = "green";
                    updateExternalLinks();
                } else {
                    msg.textContent = "âš ï¸ åšå®¢ä¾†æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ Google...";
                    fallbackGoogle(key); 
                }
            })
            .catch(err => {
                console.error(err);
                msg.textContent = "âŒ é€£ç·šéŒ¯èª¤ï¼Œå˜—è©¦ Google...";
                fallbackGoogle(key);
            });
        }

        // å‚™ç”¨æ–¹æ¡ˆ (Google Books API)
        function fallbackGoogle(keyword) {
            let q = `isbn:${keyword.replace(/[- ]/g,'')}`;
            if(keyword.length < 10) q = `intitle:${keyword}`;

            fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`)
            .then(r=>r.json()).then(data => {
                const msg = document.getElementById('api-message');
                if(data.totalItems > 0) {
                    const i = data.items[0].volumeInfo;
                    if(i.title) document.getElementById('title').value = i.title;
                    if(i.authors) document.getElementById('author').value = i.authors.join(', ');
                    if(i.publisher) document.getElementById('publisher').value = i.publisher;
                    if(i.publishedDate) {
                        let d = i.publishedDate.split('-');
                        if(d[0]) document.getElementById('year').value = d[0];
                        if(d[1]) document.getElementById('month').value = d[1];
                    }
                    if(i.description) document.getElementById('description').value = i.description;
                    if(i.imageLinks) {
                        document.getElementById('cover_url').value = (i.imageLinks.thumbnail||'').replace('http://','https://');
                        updatePreviewFromUrl();
                    }
                    msg.textContent = "âœ… Google æœ‰è³‡æ–™ (åšå®¢ä¾†ç„¡è³‡æ–™)";
                    msg.style.color = "orange";
                    updateExternalLinks();
                } else {
                    msg.textContent = "âŒ å®Œå…¨æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚";
                    msg.style.color = "red";
                }
            });
        }

        let html5QrCode;
        function startScanner() {
            document.getElementById('reader-container').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                document.getElementById('isbn').value = txt; stopScanner(); lookupBookData('isbn');
            });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop(); document.getElementById('reader-container').style.display = 'none'; }
        function handleEnter(e, t) { if(e.key==='Enter'){ e.preventDefault(); lookupBookData(t); } }
        function updatePreviewFromUrl() { 
            const u = document.getElementById('cover_url').value; 
            const b = document.getElementById('cover-preview');
            if(u){ document.getElementById('book-cover-img').src=u; b.style.display='block'; } else { b.style.display='none'; }
        }
    </script>
</body>
</html>
