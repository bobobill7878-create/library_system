<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢æ›¸ç±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        .preview-img { max-width: 150px; max-height: 200px; object-fit: cover; border: 1px solid #ddd; margin-top: 10px; display: none; }
        .scanner-box { width: 100%; max-width: 400px; margin: 0 auto; display: none; }
        .external-links a { margin-right: 10px; text-decoration: none; }
        
        /* æœå°‹çµæœå¡ç‰‡æ¨£å¼ */
        .book-card { cursor: pointer; transition: transform 0.2s; border: 1px solid #eee; }
        .book-card:hover { transform: scale(1.03); border-color: #0d6efd; background-color: #f8f9fa; }
        .book-card img { height: 140px; object-fit: contain; margin-bottom: 5px; }
        .book-card h6 { font-size: 0.9rem; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .book-card p { font-size: 0.8rem; color: #666; margin-bottom: 0; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“– æ–°å¢æ›¸ç±</h2>
            <a href="/" class="btn btn-secondary">å›é¦–é </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div id="reader-container" class="scanner-box mb-3">
                    <div id="reader"></div>
                    <button type="button" class="btn btn-danger w-100 mt-2" onclick="stopScanner()">é—œé–‰é¡é ­</button>
                </div>

                <form id="addBookForm" onsubmit="submitForm(event)">
                    
                    <div class="row g-2 mb-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">ISBN (åœ‹éš›æ›¸è™Ÿ)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="isbn" id="isbn" placeholder="æƒææˆ–è¼¸å…¥..." onkeypress="handleEnter(event, 'isbn')">
                                <button type="button" class="btn btn-outline-primary" onclick="startScanner()">ğŸ“·</button>
                                <button type="button" class="btn btn-primary" onclick="lookupBookData('isbn')">ğŸ”</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">æ›¸å <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="title" id="title" required onkeypress="handleEnter(event, 'title')">
                                <button type="button" class="btn btn-outline-secondary" onclick="lookupBookData('title')">æœæ›¸å</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <small id="api-message" class="fw-bold"></small>
                        </div>
                    </div>
                    
                    <div class="mb-3 external-links" id="link-container" style="display:none;">
                        <small class="text-muted">å¿«é€ŸæŸ¥è©¢ï¼š</small>
                        <a href="#" target="_blank" id="link-books" class="badge bg-success">åšå®¢ä¾†</a>
                        <a href="#" target="_blank" id="link-momo" class="badge bg-danger">Momo</a>
                        <a href="#" target="_blank" id="link-taaze" class="badge bg-warning text-dark">è®€å†Š</a>
                        <a href="#" target="_blank" id="link-google" class="badge bg-info text-dark">Google</a>
                    </div>

                    <hr>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">ä½œè€…</label>
                            <input type="text" class="form-control" name="author" id="author">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å‡ºç‰ˆç¤¾</label>
                            <input type="text" class="form-control" name="publisher" id="publisher">
                        </div>
                    </div>

                    <button class="btn btn-sm btn-outline-secondary mb-3 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedInfo">
                        ğŸ”½ é¡¯ç¤º/éš±è— è©³ç´°è³‡æ–™
                    </button>
                    
                    <div class="collapse show" id="advancedInfo">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">åˆ†é¡</label>
                                <select class="form-select" name="category_id" id="category_id">
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control mt-2" name="new_category" placeholder="æˆ–æ–°å¢åˆ†é¡..." style="font-size: 0.9em;">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ç³»åˆ—/é›†æ•¸</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="series" placeholder="ç³»åˆ—å">
                                    <input type="text" class="form-control" name="volume" placeholder="Vol." style="max-width: 80px;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">é–±è®€ç‹€æ…‹</label>
                                <select class="form-select" name="status" id="status">
                                    <option value="æœªè®€">ğŸ”´ æœªè®€</option>
                                    <option value="é–±è®€ä¸­">ğŸŸ¡ é–±è®€ä¸­</option>
                                    <option value="å·²è®€">ğŸŸ¢ å·²è®€</option>
                                    <option value="æ£„æ›¸">âš« æ£„æ›¸</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">å‡ºç‰ˆæ—¥æœŸ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="publish_year" id="year" placeholder="å¹´">
                                    <input type="number" class="form-control" name="publish_month" id="month" placeholder="æœˆ">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ç‰ˆæœ¬</label>
                                <select class="form-select" name="print_version" id="print_version">
                                    <option value="">--é¸æ“‡--</option>
                                    <option value="å¹³è£">å¹³è£</option>
                                    <option value="ç²¾è£">ç²¾è£</option>
                                    <option value="é›»å­æ›¸">é›»å­æ›¸</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è©•åˆ† (1-5)</label>
                                <input type="number" class="form-control" name="rating" min="1" max="5">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ç°¡ä»‹</label>
                            <textarea class="form-control" name="description" id="description" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="mb-3 p-3 bg-white border rounded">
                        <label class="form-label fw-bold">å°é¢åœ–ç‰‡</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">ç¶²å€</span>
                            <input type="text" class="form-control" name="cover_url" id="cover_url" placeholder="https://..." onchange="updatePreviewFromUrl()">
                        </div>
                        <div id="cover-preview" class="preview-img text-center">
                            <img id="book-cover-img" src="" alt="å°é¢é è¦½" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" id="submit-btn" class="btn btn-primary btn-lg">ğŸ’¾ å„²å­˜æ›¸ç±</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ” è«‹é¸æ“‡ä¸€æœ¬æ›¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <div id="search-results-container" class="row g-3">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- æ ¸å¿ƒé‚è¼¯ï¼šæœå°‹èˆ‡å½ˆçª— ---

        // 1. ç™¼é€æœå°‹è«‹æ±‚
        function lookupBookData(type) {
            let key = type === 'isbn' ? document.getElementById('isbn').value : document.getElementById('title').value;
            if(!key) { alert("è«‹è¼¸å…¥å…§å®¹"); return; }
            
            const msg = document.getElementById('api-message');
            msg.textContent = "â³ æœå°‹ä¸­...è«‹ç¨å€™";
            msg.className = "text-primary fw-bold";
            
            // å‘¼å«å¾Œç«¯åšå®¢ä¾† API
            fetch(`/api/lookup_books_tw?q=${encodeURIComponent(key)}`)
            .then(r => r.json())
            .then(resp => {
                if(resp.success && resp.results && resp.results.length > 0) {
                    msg.textContent = "âœ… æ‰¾åˆ°å¤šç­†è³‡æ–™ï¼Œè«‹é¸æ“‡ï¼š";
                    msg.className = "text-success fw-bold";
                    showModal(resp.results);
                } else {
                    msg.textContent = "âš ï¸ åšå®¢ä¾†ç„¡è³‡æ–™ï¼Œå˜—è©¦ Google...";
                    msg.className = "text-warning fw-bold";
                    fallbackGoogle(key);
                }
            })
            .catch(err => {
                console.error(err);
                msg.textContent = "âŒ é€£ç·šéŒ¯èª¤ï¼Œå˜—è©¦ Google...";
                fallbackGoogle(key);
            });
        }

        // 2. Google å‚™ç”¨æ–¹æ¡ˆ (ä¹Ÿè¦æ”¯æ´å¤šç­†é¡¯ç¤º)
        function fallbackGoogle(keyword) {
            let q = `isbn:${keyword.replace(/[- ]/g,'')}`;
            if(keyword.length < 10) q = `intitle:${keyword}`;

            fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=20`) 
            .then(r=>r.json()).then(data => {
                const msg = document.getElementById('api-message');
                if(data.totalItems > 0) {
                    msg.textContent = "âœ… Google æ‰¾åˆ°ç›¸é—œæ›¸ç±ï¼Œè«‹é¸æ“‡ï¼š";
                    msg.className = "text-success fw-bold";
                    
                    // è½‰æ› Google æ ¼å¼ç‚ºæˆ‘å€‘çš„çµ±ä¸€æ ¼å¼
                    const formatedList = data.items.map(item => {
                        const i = item.volumeInfo;
                        let y='', m='';
                        if(i.publishedDate) {
                            const d = i.publishedDate.split('-');
                            y = d[0]; m = d[1] || '';
                        }
                        return {
                            title: i.title,
                            author: i.authors ? i.authors.join(', ') : 'æœªçŸ¥',
                            publisher: i.publisher || '',
                            year: y,
                            month: m,
                            description: i.description || '',
                            cover_url: i.imageLinks ? (i.imageLinks.thumbnail||'').replace('http://','https://') : ''
                        };
                    });
                    showModal(formatedList);
                } else {
                    msg.textContent = "âŒ å®Œå…¨æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚";
                    msg.className = "text-danger fw-bold";
                }
            });
        }

        // 3. é¡¯ç¤ºå½ˆçª— (Render Modal)
        let searchResults = []; // æš«å­˜è³‡æ–™
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));

        function showModal(dataList) {
            searchResults = dataList; // å­˜èµ·ä¾†ä¾›é»é¸æ™‚ä½¿ç”¨
            const container = document.getElementById('search-results-container');
            container.innerHTML = ''; // æ¸…ç©º

            dataList.forEach((book, index) => {
                // è™•ç†æ²’æœ‰åœ–ç‰‡æ™‚çš„é¡¯ç¤º
                const imgDisplay = book.cover_url ? 
                    `<img src="${book.cover_url}" class="card-img-top p-2" alt="å°é¢">` : 
                    `<div class="d-flex align-items-center justify-content-center bg-secondary text-white" style="height:140px; margin:5px;">ç„¡å°é¢</div>`;
                
                // å»ºç«‹å¡ç‰‡ HTML
                const cardHtml = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card h-100 book-card shadow-sm" onclick="selectBook(${index})">
                            ${imgDisplay}
                            <div class="card-body p-2 text-center">
                                <h6 class="card-title fw-bold text-dark">${book.title}</h6>
                                <p class="card-text text-truncate">${book.author}</p>
                                <span class="badge bg-light text-secondary border">${book.publisher}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });

            resultModal.show();
        }

        // 4. ä½¿ç”¨è€…é»é¸æŸä¸€æœ¬æ›¸ (Fill Form)
        function selectBook(index) {
            const data = searchResults[index];
            if(!data) return;

            // å¡«å…¥è¡¨å–®
            if(data.title) document.getElementById('title').value = data.title;
            if(data.author) document.getElementById('author').value = data.author;
            if(data.publisher) document.getElementById('publisher').value = data.publisher;
            if(data.year) document.getElementById('year').value = data.year;
            if(data.month) document.getElementById('month').value = data.month;
            if(data.description) document.getElementById('description').value = data.description;
            if(data.cover_url) {
                document.getElementById('cover_url').value = data.cover_url;
                updatePreviewFromUrl();
            }

            // æ›´æ–°å¤–éƒ¨é€£çµ
            updateExternalLinks();
            
            // é—œé–‰è¦–çª—
            resultModal.hide();
            
            // æç¤º
            const msg = document.getElementById('api-message');
            msg.textContent = "âœ… å·²å¡«å…¥è³‡æ–™ï¼";
        }

        // --- å…¶ä»–è¼”åŠ©åŠŸèƒ½ ---
        function submitForm(event) {
            event.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ å„²å­˜ä¸­..."; btn.disabled = true;

            fetch('/add', { method: 'POST', body: new FormData(event.target) })
            .then(r => {
                if (r.ok) {
                    alert('âœ… æ–°å¢æˆåŠŸï¼è«‹ç¹¼çºŒä¸‹ä¸€æœ¬ã€‚');
                    resetFormPartial();
                    document.getElementById('isbn').focus();
                } else { alert('âŒ æ–°å¢å¤±æ•—'); }
            })
            .catch(e => alert('âŒ éŒ¯èª¤'))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        function resetFormPartial() {
            ['isbn','title','author','publisher','year','month','description','cover_url'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('status').value = 'æœªè®€';
            document.getElementById('print_version').value = '';
            document.getElementById('link-container').style.display = 'none';
            document.getElementById('cover-preview').style.display = 'none';
            document.getElementById('book-cover-img').src = '';
            document.getElementById('api-message').textContent = '';
        }

        function updateExternalLinks() {
            const k = document.getElementById('isbn').value.trim() || document.getElementById('title').value.trim();
            const c = document.getElementById('link-container');
            if(k) {
                c.style.display = 'block';
                document.getElementById('link-books').href = `https://search.books.com.tw/search/query/key/${k}`;
                document.getElementById('link-momo').href = `https://m.momoshop.com.tw/search.momo?searchKeyword=${k}`;
                document.getElementById('link-taaze').href = `https://www.taaze.tw/rwd_search_result.html?keyType%5B%5D=0&keyword%5B%5D=${k}`;
                document.getElementById('link-google').href = `https://www.google.com/search?q=${k}`;
            } else { c.style.display = 'none'; }
        }

        let html5QrCode;
        function startScanner() {
            document.getElementById('reader-container').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                document.getElementById('isbn').value = txt; stopScanner(); lookupBookData('isbn');
            });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop(); document.getElementById('reader-container').style.display = 'none'; }
        function handleEnter(e, t) { if(e.key==='Enter'){ e.preventDefault(); lookupBookData(t); } }
        function updatePreviewFromUrl() { 
            const u = document.getElementById('cover_url').value; 
            const b = document.getElementById('cover-preview');
            if(u){ document.getElementById('book-cover-img').src=u; b.style.display='block'; } else { b.style.display='none'; }
        }
    </script>
</body>
</html>
