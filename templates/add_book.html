<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢æ›¸ç±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .preview-img { 
            max-width: 150px; 
            max-height: 200px; 
            display: none; 
            margin-top: 10px; 
            border: 1px solid #ddd; 
            padding: 5px; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        /* èª¿æ•´ Modal å…§åˆ—è¡¨çš„é«˜åº¦èˆ‡æ²å‹• */
        #search-results-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        /* è®“æ›¸æœ¬å°é¢åœ¨åˆ—è¡¨ä¸­ä¿æŒæ¯”ä¾‹ */
        .book-thumb {
            width: 60px;
            height: 85px;
            object-fit: contain;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸ“š åœ–æ›¸ç®¡ç†ç³»çµ±</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">é¦–é </a>
                <a class="nav-link active" href="/add">æ–°å¢æ›¸ç±</a>
                <a class="nav-link" href="/categories">åˆ†é¡ç®¡ç†</a>
                <a class="nav-link" href="/dashboard">å„€è¡¨æ¿</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-9"> <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">æ–°å¢æ›¸ç±</h4>
                        <small>æ”¯æ´å¤šä¾†æºè‡ªå‹•çˆ¬èŸ²</small>
                    </div>
                    <div class="card-body">
                        
                        {% if success_message %}
                            <div class="alert alert-success alert-dismissible fade show">
                                {{ success_message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}
                        {% if error %}
                            <div class="alert alert-danger alert-dismissible fade show">
                                {{ error }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}

                        <div class="mb-4 p-3 bg-white border rounded shadow-sm">
                            <label class="form-label fw-bold text-primary">ğŸ” å…¨ç¶²æœå°‹åŠ©æ‰‹</label>
                            <div class="input-group">
                                <input type="text" id="keyword" class="form-control" placeholder="è¼¸å…¥æ›¸åé—œéµå­— (ä¾‹å¦‚: å“ˆåˆ©æ³¢ç‰¹)..." onkeypress="handleEnter(event)">
                                <button type="button" class="btn btn-primary" onclick="searchTitleModal()">é–‹å§‹æœå°‹</button>
                            </div>
                            <div class="form-text text-muted">
                                æœå°‹ç¯„åœï¼šGoogleã€åšå®¢ä¾†ã€MOMOã€Readmooã€èª å“ã€å¢Šè…³çŸ³ã€‚
                            </div>
                        </div>

                        <form id="addBookForm" method="POST" enctype="multipart/form-data">
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">ISBN (æ¢ç¢¼)</label>
                                <div class="input-group">
                                    <input type="text" name="isbn" id="isbn" class="form-control" placeholder="è¼¸å…¥ ISBN...">
                                    <button type="button" class="btn btn-info text-white" onclick="lookupBookData()">â¬‡ï¸ è‡ªå‹•å¸¶å…¥è³‡æ–™</button>
                                </div>
                                <small id="msg-box" class="form-text fw-bold"></small>
                            </div>

                            <hr>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">æ›¸å <span class="text-danger">*</span></label>
                                    <input type="text" name="title" id="title" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ä½œè€… <span class="text-danger">*</span></label>
                                    <input type="text" name="author" id="author" class="form-control" required>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">å‡ºç‰ˆç¤¾</label>
                                    <input type="text" name="publisher" id="publisher" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">åˆ†é¡</label>
                                    <select name="category" class="form-select">
                                        <option value="">é¸æ“‡åˆ†é¡...</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">å¢æ›¸ç³»åˆ—</label>
                                    <input type="text" name="series" id="series" class="form-control" placeholder="ä¾‹å¦‚: å“ˆåˆ©æ³¢ç‰¹ç³»åˆ—">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">é›†æ•¸/å†Šæ•¸</label>
                                    <input type="text" name="volume" id="volume" class="form-control" placeholder="ä¾‹å¦‚: ç¬¬ 1 é›†">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ç‰ˆæœ¬</label>
                                    <input type="text" name="print_version" class="form-control" placeholder="ä¾‹å¦‚: ç²¾è£ç‰ˆ/å†ç‰ˆ">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">å‡ºç‰ˆå¹´ä»½</label>
                                    <input type="number" name="year" id="year" class="form-control" placeholder="YYYY">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">å‡ºç‰ˆæœˆä»½</label>
                                    <input type="number" name="month" id="month" class="form-control" placeholder="MM">
                                </div>
                            </div>

                            <div class="p-3 mb-3 bg-light border rounded">
                                <label class="form-label fw-bold">é–±è®€ç®¡ç†</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">ç‹€æ…‹</label>
                                        <select name="status" class="form-select">
                                            <option value="æœªè®€">æœªè®€</option>
                                            <option value="é–±è®€ä¸­">é–±è®€ä¸­</option>
                                            <option value="å·²è®€">å·²è®€</option>
                                            <option value="æ£„å‘">æ£„å‘</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">è©•åˆ† (0-5)</label>
                                        <input type="number" name="rating" class="form-control" min="0" max="5" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ä½ç½®</label>
                                        <input type="text" name="location" class="form-control" placeholder="ä¾‹å¦‚: æ›¸æ«ƒA-3">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">å°é¢è¨­å®š</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">ç¶²å€</span>
                                    <input type="text" name="cover_url" id="cover_url" class="form-control" placeholder="åœ–ç‰‡é€£çµ..." onchange="updatePreview()">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-text">ä¸Šå‚³</span>
                                    <input type="file" name="cover_file" class="form-control" accept="image/*">
                                </div>
                                <div id="preview-area" class="text-center">
                                    <img id="preview-img" class="preview-img" alt="å°é¢é è¦½">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">æ¨™ç±¤ (Tags)</label>
                                <input type="text" name="tags" class="form-control" placeholder="ä¾‹å¦‚: å¥‡å¹», æ”¹ç·¨é›»å½±, å¿…è®€">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">å…§å®¹ç°¡ä»‹</label>
                                <textarea name="description" id="description" class="form-control" rows="4"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ç§äººå‚™è¨»</label>
                                <textarea name="notes" class="form-control" rows="2"></textarea>
                            </div>

                            <div class="d-grid gap-2 pt-3">
                                <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªæ–°å¢æ›¸ç±</button>
                                <a href="/" class="btn btn-outline-secondary">å–æ¶ˆè¿”å›</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">ğŸ“š æœå°‹çµæœ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="loading-spinner" class="text-center p-5" style="display:none;">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                        <p class="mt-3 text-muted fs-5">æ­£åœ¨å¾å„å¤§æ›¸åº—æ’ˆå–è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
                    </div>

                    <ul class="nav nav-tabs mb-3" id="sourceTabs" role="tablist" style="display:none;">
                        <li class="nav-item">
                            <button class="nav-link active" onclick="filterResults('all')" id="tab-all">
                                å…¨éƒ¨ <span class="badge bg-secondary rounded-pill" id="count-all">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="filterResults('åšå®¢ä¾†')" id="tab-books">
                                åšå®¢ä¾† <span class="badge bg-secondary rounded-pill" id="count-books">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="filterResults('èª å“')" id="tab-eslite">
                                èª å“ <span class="badge bg-secondary rounded-pill" id="count-eslite">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="filterResults('MOMO')" id="tab-momo">
                                MOMO <span class="badge bg-secondary rounded-pill" id="count-momo">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="filterResults('å¢Šè…³çŸ³')" id="tab-stepstone">
                                å¢Šè…³çŸ³ <span class="badge bg-secondary rounded-pill" id="count-stepstone">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="filterResults('Readmoo')" id="tab-readmoo">
                                Readmoo <span class="badge bg-secondary rounded-pill" id="count-readmoo">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" onclick="filterResults('Google')" id="tab-google">
                                Google <span class="badge bg-secondary rounded-pill" id="count-google">0</span>
                            </button>
                        </li>
                    </ul>

                    <div id="search-results-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let allSearchResults = [];

        // --- åœ–ç‰‡é è¦½åŠŸèƒ½ ---
        function updatePreview() {
            const url = document.getElementById('cover_url').value;
            const img = document.getElementById('preview-img');
            img.src = url || '';
            img.style.display = url ? 'block' : 'none';
        }

        // --- Enter éµè§¸ç™¼æœå°‹ ---
        function handleEnter(e) {
            if(e.key === 'Enter') searchTitleModal();
        }

        // --- 1. ISBN å–®ä¸€æŸ¥è©¢ ---
        function lookupBookData() {
            const isbn = document.getElementById('isbn').value.replace(/-/g, '').trim();
            if(!isbn) { alert("è«‹è¼¸å…¥ ISBN"); return; }
            
            const msg = document.getElementById('msg-box');
            msg.innerText = "â³ æ­£åœ¨æŸ¥è©¢å„å¤§è³‡æ–™åº«..."; 
            msg.className = "form-text fw-bold text-primary";

            fetch(`/api/lookup_isbn/${isbn}`)
                .then(r => r.json())
                .then(d => {
                    if(d.error) { 
                        msg.innerText = "âŒ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹å˜—è©¦æ‰‹å‹•è¼¸å…¥æˆ–ä½¿ç”¨é—œéµå­—æœå°‹ã€‚"; 
                        msg.className = "form-text fw-bold text-danger";
                    } else { 
                        msg.innerHTML = `âœ… æˆåŠŸå–å¾—è³‡æ–™ï¼ä¾†æº: <span class="badge bg-success">${d.source}</span>`; 
                        msg.className = "form-text fw-bold text-success";
                        fillForm(d); 
                    }
                })
                .catch(() => { 
                    msg.innerText = "âŒ ä¼ºæœå™¨é€£ç·šéŒ¯èª¤"; 
                    msg.className = "form-text fw-bold text-danger";
                });
        }

        // --- å¡«å¯«è¡¨å–®è¼”åŠ©å‡½å¼ ---
        function fillForm(d) {
            if(d.title) document.getElementById('title').value = d.title;
            if(d.author) document.getElementById('author').value = d.author;
            if(d.publisher) document.getElementById('publisher').value = d.publisher;
            if(d.year) document.getElementById('year').value = d.year;
            if(d.month) document.getElementById('month').value = d.month;
            if(d.description) document.getElementById('description').value = d.description;
            if(d.cover_url) {
                document.getElementById('cover_url').value = d.cover_url;
                updatePreview();
            }
        }

        // --- 2. é—œéµå­—å¤šä¾†æºæœå°‹ (Modal) ---
        function searchTitleModal() {
            const kw = document.getElementById('keyword').value.trim();
            if(!kw) { alert("è«‹è¼¸å…¥é—œéµå­—"); return; }

            // UI åˆå§‹åŒ–
            const resDiv = document.getElementById('search-results-list');
            const spinner = document.getElementById('loading-spinner');
            const tabs = document.getElementById('sourceTabs');
            
            resDiv.innerHTML = "";
            spinner.style.display = "block";
            tabs.style.display = "none";
            allSearchResults = []; // æ¸…ç©ºèˆŠè³‡æ–™
            
            // é–‹å•Ÿ Modal
            new bootstrap.Modal(document.getElementById('searchModal')).show();

            // å‘¼å«å¾Œç«¯ API
            fetch(`/api/search_keyword/${encodeURIComponent(kw)}`)
                .then(r => r.json())
                .then(data => {
                    spinner.style.display = "none";
                    tabs.style.display = "flex";
                    
                    if(data.length === 0) { 
                        resDiv.innerHTML = `
                            <div class="text-center p-5">
                                <p class="text-muted fs-5">æ‰¾ä¸åˆ°èˆ‡ã€Œ${kw}ã€ç›¸é—œçš„æ›¸ç±ã€‚</p>
                                <small>è«‹å˜—è©¦æ›´æ›é—œéµå­—ï¼Œæˆ–ç›´æ¥æ‰‹å‹•è¼¸å…¥è³‡æ–™ã€‚</small>
                            </div>`; 
                        return; 
                    }

                    // å„²å­˜ä¸¦è™•ç†è³‡æ–™
                    allSearchResults = data;
                    updateTabCounts();
                    filterResults('all'); // é è¨­é¡¯ç¤ºå…¨éƒ¨
                })
                .catch(err => { 
                    spinner.style.display = "none";
                    resDiv.innerHTML = `<div class="alert alert-danger">æœå°‹ç™¼ç”ŸéŒ¯èª¤: ${err}</div>`; 
                });
        }

        // --- æ›´æ–°åˆ†é æ¨™ç±¤ä¸Šçš„æ•¸å­— ---
        function updateTabCounts() {
            const sources = ['books', 'momo', 'eslite', 'stepstone', 'readmoo', 'google'];
            const mapping = {
                'books': 'åšå®¢ä¾†', 'momo': 'MOMO', 'eslite': 'èª å“', 
                'stepstone': 'å¢Šè…³çŸ³', 'readmoo': 'Readmoo', 'google': 'Google'
            };

            // å…¨éƒ¨
            document.getElementById('count-all').innerText = allSearchResults.length;

            // å„åˆ¥ä¾†æº
            sources.forEach(key => {
                const count = allSearchResults.filter(item => item.source === mapping[key]).length;
                document.getElementById(`count-${key}`).innerText = count;
            });
        }

        // --- åˆ‡æ›åˆ†é èˆ‡éæ¿¾åˆ—è¡¨ ---
        function filterResults(source) {
            // 1. è¨­å®šæŒ‰éˆ•æ¨£å¼ (Active)
            document.querySelectorAll('#sourceTabs .nav-link').forEach(btn => btn.classList.remove('active'));
            
            let btnId = 'tab-all';
            if(source === 'åšå®¢ä¾†') btnId = 'tab-books';
            else if(source === 'èª å“') btnId = 'tab-eslite';
            else if(source === 'MOMO') btnId = 'tab-momo';
            else if(source === 'å¢Šè…³çŸ³') btnId = 'tab-stepstone';
            else if(source === 'Readmoo') btnId = 'tab-readmoo';
            else if(source === 'Google') btnId = 'tab-google';
            
            document.getElementById(btnId).classList.add('active');

            // 2. éæ¿¾è³‡æ–™
            let filteredData = allSearchResults;
            if (source !== 'all') {
                filteredData = allSearchResults.filter(item => item.source === source);
            }

            // 3. æ¸²æŸ“ç•«é¢
            renderList(filteredData);
        }

        // --- æ¸²æŸ“ HTML åˆ—è¡¨ ---
        function renderList(data) {
            const resDiv = document.getElementById('search-results-list');
            if (data.length === 0) {
                resDiv.innerHTML = "<div class='text-center p-5 text-muted'>æ­¤ä¾†æºç„¡æœå°‹çµæœ</div>";
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            data.forEach(item => {
                const jsonItem = JSON.stringify(item).replace(/"/g, '&quot;');
                
                // è¨­å®šä¾†æºæ¨™ç±¤é¡è‰²
                let badgeClass = "bg-secondary";
                if(item.source === "åšå®¢ä¾†") badgeClass = "bg-success";        // åšå®¢ä¾†ç¶ 
                else if(item.source === "MOMO") badgeClass = "bg-danger";      // MOMOç´…
                else if(item.source === "èª å“") badgeClass = "bg-warning text-dark"; // èª å“å¡å…¶/é»ƒ
                else if(item.source === "å¢Šè…³çŸ³") badgeClass = "bg-primary";   // å¢Šè…³çŸ³è—
                else if(item.source === "Readmoo") badgeClass = "bg-info text-dark"; // Readmooé’
                
                // è™•ç†ä½œè€…é¡¯ç¤ºéé•·å•é¡Œ
                let authorDisplay = item.author || 'æœªçŸ¥ä½œè€…';
                if(authorDisplay.length > 20) authorDisplay = authorDisplay.substring(0, 20) + '...';

                html += `
                    <button type="button" class="list-group-item list-group-item-action p-3" onclick="selectBook(${jsonItem})">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img src="${item.cover_url}" class="book-thumb rounded" onerror="this.src='https://placehold.co/60x85?text=No+Img'">
                            </div>
                            <div class="col">
                                <div class="d-flex w-100 justify-content-between mb-1">
                                    <h6 class="mb-0 fw-bold text-primary text-truncate" style="max-width: 70%;">${item.title}</h6>
                                    <span class="badge ${badgeClass}">${item.source}</span>
                                </div>
                                <div class="small text-muted">
                                    <i class="bi bi-person"></i> ä½œè€…: ${authorDisplay} | 
                                    <i class="bi bi-building"></i> å‡ºç‰ˆ: ${item.publisher || 'æœªçŸ¥'}
                                </div>
                            </div>
                        </div>
                    </button>
                `;
            });
            html += '</div>';
            resDiv.innerHTML = html;
        }

        // --- é¸æ“‡æ›¸ç±ä¸¦å¸¶å…¥è¡¨å–® ---
        function selectBook(item) {
            fillForm(item);
            if(item.isbn) document.getElementById('isbn').value = item.isbn;
            
            // é—œé–‰ Modal
            const modalEl = document.getElementById('searchModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        // --- è¡¨å–®é€å‡ºæª¢æŸ¥ (é‡è¤‡æ›¸ååµæ¸¬) ---
        document.getElementById('addBookForm').addEventListener('submit', async function(e) {
            if (!this.checkValidity()) return;
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const btn = this.querySelector('button[type="submit"]');
            
            // é¿å…é‡è¤‡é»æ“Š
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";

            try {
                const res = await fetch(`/api/check_title?title=${encodeURIComponent(title)}`);
                const data = await res.json();
                
                if (data.exists) {
                    const confirmAdd = confirm(
                        `âš ï¸ ç³»çµ±åµæ¸¬åˆ°åº«å­˜ä¸­æœ‰ç›¸ä¼¼æ›¸ç±ï¼\n\n` +
                        `æ‚¨çš„è¼¸å…¥ï¼š${title}\n` +
                        `åº«å­˜ç›¸ä¼¼ï¼š${data.match}\n\n` +
                        `æ‚¨ç¢ºå®šè¦é‡è¤‡æ–°å¢é€™æœ¬æ›¸å—ï¼Ÿ`
                    );
                    if (!confirmAdd) {
                        btn.disabled = false;
                        btn.innerText = "ç¢ºèªæ–°å¢æ›¸ç±";
                        return;
                    }
                }
                this.submit();
            } catch (err) {
                // å¦‚æœæª¢æŸ¥ API å¤±æ•—ï¼Œé‚„æ˜¯å…è¨±é€å‡º
                console.error(err);
                this.submit(); 
            }
        });
    </script>
</body>
</html>
