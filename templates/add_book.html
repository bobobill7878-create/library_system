<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_edit %}編輯書籍{% else %}新增書籍{% endif %} - 圖書管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .preview-box {
            width: 100%; height: 320px; 
            background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            position: relative;
        }
        .preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .book-thumb-list { width: 50px; height: 75px; object-fit: cover; background: #eee; border-radius: 4px; }
        .result-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .result-item:hover { background: #f1f3f5; border-left-color: #0d6efd; }
        .sticky-tabs { position: sticky; top: 0; background: white; z-index: 10; padding-top: 10px; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-book-half"></i> 個人圖書館</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">書庫總覽</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/add">新增書籍</a></li>
                    <li class="nav-item"><a class="nav-link" href="/categories">分類管理</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-lg-11">
                
                {% if not is_edit %}
                <div class="card shadow-sm mb-4 border-primary">
                    <div class="card-body bg-white">
                        <h5 class="card-title text-primary"><i class="bi bi-cloud-download"></i> 網路書籍搜尋</h5>
                        <div class="input-group input-group-lg">
                            <input type="text" id="keyword" class="form-control" placeholder="輸入書名、ISBN 或 作者..." onkeypress="if(event.key==='Enter') searchModal()">
                            <button class="btn btn-primary px-4" onclick="searchModal()">
                                <i class="bi bi-search"></i> 搜尋
                            </button>
                        </div>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle"></i> 來源整合：Google API (最穩)、Readmoo (推薦)、三民書局、博客來。
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            {% if is_edit %}
                                <i class="bi bi-pencil-square"></i> 編輯書籍資料
                            {% else %}
                                <i class="bi bi-plus-circle"></i> 填寫書籍資料
                            {% endif %}
                        </h4>
                        {% if is_edit %}
                            <span class="badge bg-warning text-dark">編輯模式 ID: {{ book.id }}</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        
                        {% with messages = get_flashed_messages(with_categories=true) %}
                          {% if messages %}
                            {% for category, message in messages %}
                              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                              </div>
                            {% endfor %}
                          {% endif %}
                        {% endwith %}

                        <form method="POST" enctype="multipart/form-data">
                            
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">封面預覽</label>
                                        <div class="preview-box mb-2">
                                            <img id="img-preview" src="{{ book.cover_url if book and book.cover_url else '' }}" style="display:{{ 'block' if book and book.cover_url else 'none' }};">
                                            <div id="img-placeholder" class="text-muted text-center" style="display:{{ 'none' if book and book.cover_url else 'block' }};">
                                                <i class="bi bi-image fs-1"></i><br>預覽區域
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">封面網址 (URL)</label>
                                        <input type="text" name="cover_url" id="cover_url" class="form-control form-control-sm" placeholder="https://..." value="{{ book.cover_url if book else '' }}" onchange="updatePreview()">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">或 上傳圖片檔案</label>
                                        <input type="file" name="cover_file" id="cover_file" class="form-control form-control-sm" accept="image/*" onchange="previewFile()">
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">ISBN 條碼</label>
                                            <div class="input-group">
                                                <input type="text" name="isbn" id="isbn" class="form-control" placeholder="掃描或輸入" value="{{ book.isbn if book else '' }}">
                                                <button type="button" class="btn btn-outline-secondary" onclick="lookupISBN()">
                                                    <i class="bi bi-magic"></i> 帶入
                                                </button>
                                            </div>
                                            <small id="isbn-msg" class="text-danger"></small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">分類</label>
                                            <div class="input-group">
                                                <select name="category" id="category" class="form-select">
                                                    <option value="">未分類</option>
                                                    {% for c in categories %}
                                                    <option value="{{ c.id }}" {% if book and book.category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <a href="/categories" class="btn btn-outline-secondary" title="管理分類" target="_blank">+</a>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-7">
                                            <label class="form-label fw-bold">書名 <span class="text-danger">*</span></label>
                                            <input type="text" name="title" id="title" class="form-control" required value="{{ book.title if book else '' }}" onblur="checkTitle()">
                                            <div id="title-feedback" class="invalid-feedback"></div>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label fw-bold">作者 <span class="text-danger">*</span></label>
                                            <input type="text" name="author" id="author" class="form-control" required value="{{ book.author if book else '' }}">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">出版社</label>
                                            <input type="text" name="publisher" id="publisher" class="form-control" value="{{ book.publisher if book else '' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">出版年</label>
                                            <input type="number" name="year" id="year" class="form-control" placeholder="YYYY" value="{{ book.year if book else '' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">出版月</label>
                                            <input type="number" name="month" id="month" class="form-control" placeholder="MM" min="1" max="12" value="{{ book.month if book else '' }}">
                                        </div>
                                    </div>

                                    <div class="row mb-3 bg-light p-2 rounded">
                                        <div class="col-md-6">
                                            <label class="form-label small">叢書系列</label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" name="series" id="series" class="form-control" placeholder="系列名" value="{{ book.series if book else '' }}">
                                                <span class="input-group-text">集數</span>
                                                <input type="text" name="volume" id="volume" class="form-control" placeholder="1" style="max-width: 60px;" value="{{ book.volume if book else '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">版本/位置</label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" name="print_version" id="print_version" class="form-control" placeholder="精裝/首刷" value="{{ book.print_version if book else '' }}">
                                                <input type="text" name="location" id="location" class="form-control" placeholder="書櫃位置" value="{{ book.location if book else '' }}">
                                            </div>
                                        </div>
                                    </div>

                                    <hr>

                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">閱讀狀態</label>
                                            <select name="status" id="status" class="form-select">
                                                <option value="未讀" {% if book and book.status == '未讀' %}selected{% endif %}>未讀</option>
                                                <option value="閱讀中" {% if book and book.status == '閱讀中' %}selected{% endif %}>閱讀中</option>
                                                <option value="已讀" {% if book and book.status == '已讀' %}selected{% endif %}>已讀</option>
                                                <option value="棄坑" {% if book and book.status == '棄坑' %}selected{% endif %}>棄坑</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">個人評分 (0-5)</label>
                                            <input type="number" name="rating" id="rating" class="form-control" min="0" max="5" value="{{ book.rating if book else 0 }}">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">標籤 (Tags)</label>
                                            <input type="text" name="tags" id="tags" class="form-control" placeholder="#科幻 #推薦" value="{{ book.tags if book else '' }}">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">內容簡介</label>
                                        <textarea name="description" id="description" class="form-control" rows="4">{{ book.description if book else '' }}</textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">私人備註</label>
                                        <textarea name="notes" id="notes" class="form-control" rows="2" placeholder="閱讀心得、借出紀錄...">{{ book.notes if book else '' }}</textarea>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                        <a href="/" class="btn btn-secondary me-md-2">取消</a>
                                        <button type="submit" class="btn btn-primary px-5">
                                            {% if is_edit %}儲存變更{% else %}新增書籍{% endif %}
                                        </button>
                                    </div>

                                </div> </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-search"></i> 搜尋結果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="loading" class="text-center p-5" style="display:none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3 text-muted">正在連線各大資料庫...</p>
                    </div>
                    
                    <div id="result-area" style="display:none;">
                        <ul class="nav nav-tabs nav-justified sticky-tabs bg-light px-2" id="sourceTabs">
                            <li class="nav-item"><button class="nav-link active" onclick="filter('all')" id="tab-all">全部 <span class="badge bg-secondary rounded-pill" id="cnt-all">0</span></button></li>
                            <li class="nav-item"><button class="nav-link" onclick="filter('GoogleAPI')" id="tab-google">Google <span class="badge bg-secondary rounded-pill" id="cnt-google">0</span></button></li>
                            <li class="nav-item"><button class="nav-link" onclick="filter('Readmoo')" id="tab-readmoo">Readmoo <span class="badge bg-secondary rounded-pill" id="cnt-readmoo">0</span></button></li>
                            <li class="nav-item"><button class="nav-link" onclick="filter('三民')" id="tab-sanmin">三民 <span class="badge bg-secondary rounded-pill" id="cnt-sanmin">0</span></button></li>
                            <li class="nav-item"><button class="nav-link" onclick="filter('博客來')" id="tab-books">博客來 <span class="badge bg-secondary rounded-pill" id="cnt-books">0</span></button></li>
                        </ul>
                        <div class="list-group list-group-flush" id="list-container"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <small class="text-muted me-auto">點擊項目即可自動填入</small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 圖片預覽 ---
        function updatePreview() {
            const url = document.getElementById('cover_url').value;
            const img = document.getElementById('img-preview');
            const ph = document.getElementById('img-placeholder');
            if(url) {
                img.src = url;
                img.style.display = 'block';
                ph.style.display = 'none';
                img.onerror = () => { img.style.display='none'; ph.style.display='block'; };
            } else {
                img.style.display = 'none';
                ph.style.display = 'block';
            }
        }

        function previewFile() {
            const file = document.getElementById('cover_file').files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.getElementById('img-preview');
                    img.src = e.target.result;
                    img.style.display='block';
                    document.getElementById('img-placeholder').style.display='none';
                    document.getElementById('cover_url').value = ''; // 清空網址欄位
                }
                reader.readAsDataURL(file);
            }
        }

        // --- ISBN 查詢 ---
        function lookupISBN() {
            const isbn = document.getElementById('isbn').value.trim();
            const msg = document.getElementById('isbn-msg');
            if(!isbn) { alert('請輸入 ISBN'); return; }
            
            msg.innerText = "查詢中...";
            msg.className = "text-muted";
            
            fetch(`/api/lookup_isbn/${isbn}`)
                .then(r => { if(!r.ok) throw new Error(); return r.json(); })
                .then(d => {
                    fillForm(d);
                    msg.innerText = "✅ 查詢成功"; msg.className = "text-success";
                })
                .catch(() => {
                    msg.innerText = "❌ 查無資料"; msg.className = "text-danger";
                });
        }

        // --- 重複書名檢查 ---
        function checkTitle() {
            const t = document.getElementById('title').value.trim();
            if(!t) return;
            // 如果是編輯模式，可能不需要一直警告，視需求而定
            fetch(`/api/check_title?title=${encodeURIComponent(t)}`)
                .then(r=>r.json())
                .then(d => {
                    const el = document.getElementById('title');
                    const fb = document.getElementById('title-feedback');
                    if(d.exists) {
                        el.classList.add('is-invalid');
                        fb.innerText = `注意：資料庫已有《${d.match}》`;
                    } else {
                        el.classList.remove('is-invalid');
                    }
                });
        }

        // --- 搜尋 Modal 邏輯 ---
        let allData = [];
        function searchModal() {
            const k = document.getElementById('keyword').value.trim();
            if(!k) return alert("請輸入關鍵字");
            
            const m = new bootstrap.Modal(document.getElementById('searchModal'));
            m.show();
            
            document.getElementById('loading').style.display='block';
            document.getElementById('result-area').style.display='none';
            allData = [];

            fetch(`/api/search_keyword/${encodeURIComponent(k)}`)
                .then(r=>r.json())
                .then(data => {
                    allData = data;
                    updateCounts();
                    filter('all');
                    document.getElementById('loading').style.display='none';
                    document.getElementById('result-area').style.display='block';
                });
        }

        function updateCounts() {
            const c = (s) => allData.filter(x=>x.source===s).length;
            document.getElementById('cnt-all').innerText = allData.length;
            document.getElementById('cnt-google').innerText = c('GoogleAPI');
            document.getElementById('cnt-readmoo').innerText = c('Readmoo');
            document.getElementById('cnt-sanmin').innerText = c('三民');
            document.getElementById('cnt-books').innerText = c('博客來');
        }

        function filter(src) {
            document.querySelectorAll('#sourceTabs .nav-link').forEach(b=>b.classList.remove('active'));
            let tid = 'tab-all';
            if(src==='GoogleAPI') tid='tab-google';
            if(src==='Readmoo') tid='tab-readmoo';
            if(src==='三民') tid='tab-sanmin';
            if(src==='博客來') tid='tab-books';
            document.getElementById(tid).classList.add('active');

            const list = document.getElementById('list-container');
            const items = src==='all' ? allData : allData.filter(x=>x.source===src);
            
            if(items.length===0) {
                list.innerHTML = '<div class="p-5 text-center text-muted">此來源無結果</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                let badge = 'bg-secondary';
                if(item.source==='GoogleAPI') badge='bg-primary';
                if(item.source==='Readmoo') badge='bg-success';
                if(item.source==='三民') badge='bg-info text-dark';
                
                // 安全 JSON 序列化
                const json = JSON.stringify(item).replace(/"/g, '&quot;');
                
                html += `
                <button type="button" class="list-group-item list-group-item-action result-item p-3" onclick="selectBook(${json})">
                    <div class="d-flex">
                        <img src="${item.cover_url || ''}" class="book-thumb-list me-3" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2VeeSIvPjwvc3ZnPg=='">
                        <div class="flex-grow-1">
                            <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 fw-bold text-truncate" style="max-width:350px;">${item.title}</h6>
                                <span class="badge ${badge}">${item.source}</span>
                            </div>
                            <small class="text-muted d-block mb-1">${item.author || '未知'} | ${item.publisher || '未知'}</small>
                            <small class="text-secondary text-truncate d-block" style="max-width:450px;">${item.description ? item.description.substring(0,50)+'...' : ''}</small>
                        </div>
                    </div>
                </button>`;
            });
            list.innerHTML = html;
        }

        function selectBook(d) {
            fillForm(d);
            bootstrap.Modal.getInstance(document.getElementById('searchModal')).hide();
        }

        function fillForm(d) {
            const map = {
                'title': d.title, 'author': d.author, 'publisher': d.publisher,
                'isbn': d.isbn, 'description': d.description, 'year': d.year,
                'cover_url': d.cover_url
            };
            for(let k in map) {
                if(document.getElementById(k) && map[k]) document.getElementById(k).value = map[k];
            }
            updatePreview();
        }
    </script>
</body>
</html>
