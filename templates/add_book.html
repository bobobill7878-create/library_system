<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢åœ–æ›¸</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; display: flex; flex-direction: column; align-items: center; background-color: #f9f9f9; }
        
        /* é é¢é ‚éƒ¨å°èˆªåˆ— */
        .nav-bar { width: 100%; max-width: 650px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-bar h1 { margin: 0; color: #333; font-size: 24px; }
        .btn-home { background-color: #6c757d; color: white; text-decoration: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 14px; display: inline-flex; align-items: center; }
        .btn-home:hover { background-color: #5a6268; }

        form { max-width: 650px; width: 100%; padding: 30px; border: 1px solid #ddd; border-radius: 12px; background-color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        label { font-weight: bold; color: #555; display: block; margin-top: 15px; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        input:focus, textarea:focus { border-color: #007bff; outline: none; }
        
        .row { display: flex; gap: 15px; } 
        .row > div { flex: 1; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 10px 15px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; transition: background 0.2s; white-space: nowrap; }
        .btn-scan { background-color: #17a2b8; }
        .btn-scan:hover { background-color: #138496; }
        .btn-search { background-color: #007bff; }
        .btn-search:hover { background-color: #0069d9; }
        .btn-submit { background-color: #28a745; width: 100%; font-size: 18px; margin-top: 25px; padding: 12px; }
        .btn-submit:hover { background-color: #218838; }
        
        /* å¤–éƒ¨é€£çµå€å¡Š */
        .external-links { margin-top: 10px; padding: 10px; background-color: #f1f1f1; border-radius: 8px; font-size: 14px; }
        .external-links span { color: #666; margin-right: 10px; }
        .external-links a { display: inline-block; text-decoration: none; color: white; padding: 5px 10px; border-radius: 4px; margin-right: 5px; font-size: 12px; transition: opacity 0.2s; }
        .external-links a:hover { opacity: 0.8; }
        .link-books { background-color: #8cc63f; }
        .link-momo { background-color: #d0021b; }
        .link-taaze { background-color: #ff9900; }
        .link-google { background-color: #4285f4; }

        /* æƒæå™¨èˆ‡é è¦½ */
        #reader-container { display: none; margin-bottom: 15px; border: 2px dashed #007bff; padding: 10px; border-radius: 8px; background: #e9f7fe; text-align: center; }
        #reader { width: 100%; max-width: 400px; margin: 0 auto; }
        
        .cover-preview { display: none; margin: 15px auto; width: 150px; text-align: center; padding: 5px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
        .cover-preview img { width: 100%; height: auto; border-radius: 4px; display: block; }

        .message-box { min-height: 20px; font-size: 14px; margin-top: 5px; font-weight: bold; }
        .input-group { display: flex; gap: 8px; align-items: center; }
    </style>
</head>
<body>
    
    <div class="nav-bar">
        <a href="/" class="btn-home">â¬… å›é¦–é </a>
        <h1>â• æ–°å¢åœ–æ›¸</h1>
        <div style="width: 80px;"></div> </div>

    <form id="addBookForm" onsubmit="submitForm(event)" enctype="multipart/form-data">
        
        <div id="reader-container">
            <div id="reader"></div>
            <button type="button" class="btn" style="background:#dc3545; margin-top:10px;" onclick="stopScanner()">é—œé–‰é¡é ­</button>
        </div>
        
        <label>ISBN (åœ‹éš›æ¨™æº–æ›¸è™Ÿ):</label>
        <div class="input-group">
            <input type="text" id="isbn" name="isbn" placeholder="æƒææˆ–è¼¸å…¥ ISBN..." oninput="updateExternalLinks()" onkeydown="handleEnter(event, 'isbn')">
            <button type="button" class="btn btn-scan" onclick="startScanner()">ğŸ“· æƒæ</button>
            <button type="button" class="btn btn-search" onclick="lookupBookData('isbn')">ğŸ” æŸ¥ ISBN</button>
        </div>
        
        <div class="external-links" id="link-container" style="display:none;">
            <span>æ‰¾ä¸åˆ°ï¼Ÿè©¦è©¦å¤–éƒ¨æœå°‹ï¼š</span>
            <a href="#" target="_blank" id="link-books" class="link-books">åšå®¢ä¾†</a>
            <a href="#" target="_blank" id="link-momo" class="link-momo">Momo</a>
            <a href="#" target="_blank" id="link-taaze" class="link-taaze">è®€å†Š</a>
            <a href="#" target="_blank" id="link-google" class="link-google">Google</a>
        </div>
        
        <div id="api-message" class="message-box"></div>

        <div id="cover-preview" class="cover-preview">
            <img id="book-cover-img" src="">
            <p style="font-size:12px; color:#666; margin:5px 0;">å°é¢é è¦½</p>
        </div>

        <label>æ›¸å <span style="color:red">*</span>:</label> 
        <div class="input-group">
            <input type="text" id="title" name="title" required placeholder="è¼¸å…¥æ›¸å..." oninput="updateExternalLinks()" onkeydown="handleEnter(event, 'title')">
            <button type="button" class="btn btn-search" style="background-color: #6c757d;" onclick="lookupBookData('title')">ğŸ” æŸ¥æ›¸å</button>
        </div>

        <div class="row">
            <div>
                <label>ä½œè€… <span style="color:red">*</span>:</label>
                <input type="text" id="author" name="author" required>
            </div>
            <div>
                <label>å‡ºç‰ˆç¤¾:</label>
                <input type="text" id="publisher" name="publisher">
            </div>
        </div>

        <div class="row">
            <div>
                <label>åˆ†é¡:</label>
                <select name="category" id="category">
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>ç‹€æ…‹:</label>
                <select name="status" id="status">
                    <option value="æœªè®€" selected>ğŸ”´ æœªè®€</option>
                    <option value="é–±è®€ä¸­">ğŸ”µ é–±è®€ä¸­</option>
                    <option value="å·²è®€å®Œ">ğŸŸ¢ å·²è®€å®Œ</option>
                    <option value="æ£„å‘">âš« æ£„å‘</option>
                </select>
            </div>
        </div>
        
        <label>å°é¢åœ–ç‰‡:</label>
        <div class="row">
            <div>
                <input type="text" id="cover_url" name="cover_url" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€..." oninput="updatePreviewFromUrl()">
                <div style="font-size:12px; color:#888; margin-top:2px;">æˆ–æ˜¯</div>
                <input type="file" id="cover_file" name="cover_file" accept="image/*" onchange="updatePreviewFromFile(this)">
            </div>
        </div>

        <div class="row">
            <div><label>å‡ºç‰ˆå¹´:</label><input type="number" id="year" name="year"></div>
            <div><label>å‡ºç‰ˆæœˆ:</label><input type="number" id="month" name="month"></div>
        </div>
        
        <label>å¤§ç¶±/ç°¡ä»‹:</label>
        <textarea id="description" name="description" rows="4"></textarea>

        <label>å€‹äººç­†è¨˜:</label>
        <textarea id="notes" name="notes" rows="2"></textarea>
        
        <button type="submit" class="btn btn-submit" id="submit-btn">ğŸ’¾ å„²å­˜ä¸¦æ–°å¢ä¸‹ä¸€æœ¬</button>
    </form>

    <script>
        // --- â˜…â˜…â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šä¸æ›é æäº¤è¡¨å–® â˜…â˜…â˜… ---
        function submitForm(event) {
            event.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„è·³é è¡Œç‚º
            
            const form = event.target;
            const formData = new FormData(form);
            const btn = document.getElementById('submit-btn');
            
            // è®Šæ›´æŒ‰éˆ•ç‹€æ…‹é¿å…é‡è¤‡é»æ“Š
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = "â³ å„²å­˜ä¸­...";
            btn.disabled = true;

            fetch('/', { // ç™¼é€åˆ°æ ¹ç›®éŒ„ (æˆ–åŸæœ¬çš„ action åœ°å€)
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // 1. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    alert('âœ… æ›¸ç±å·²æ–°å¢æˆåŠŸï¼\næ‚¨å¯ä»¥ç¹¼çºŒè¼¸å…¥ä¸‹ä¸€æœ¬ã€‚');
                    
                    // 2. æ¸…ç©ºè¡¨å–® (é™¤äº†åˆ†é¡ï¼Œå› ç‚ºé€šå¸¸æœƒé€£çºŒè¼¸å…¥åŒåˆ†é¡çš„æ›¸)
                    resetFormPartial();
                    
                    // 3. ç„¦é»å›åˆ° ISBN æ¬„ä½
                    document.getElementById('isbn').focus();
                } else {
                    alert('âŒ æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™æ˜¯å¦å®Œæ•´ã€‚');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            })
            .finally(() => {
                // æ¢å¾©æŒ‰éˆ•
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            });
        }

        // éƒ¨åˆ†æ¸…ç©ºï¼šä¿ç•™åˆ†é¡ï¼Œæ¸…ç©ºå…¶ä»–
        function resetFormPartial() {
            document.getElementById('isbn').value = '';
            document.getElementById('title').value = '';
            document.getElementById('author').value = '';
            document.getElementById('publisher').value = '';
            document.getElementById('year').value = '';
            document.getElementById('month').value = '';
            document.getElementById('description').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('cover_url').value = '';
            document.getElementById('cover_file').value = '';
            document.getElementById('status').value = 'æœªè®€'; // é‡ç½®ç‚ºæœªè®€
            
            // æ¸…ç©ºå…¶ä»– UI ç‹€æ…‹
            document.getElementById('link-container').style.display = 'none';
            document.getElementById('api-message').textContent = '';
            document.getElementById('cover-preview').style.display = 'none';
            document.getElementById('book-cover-img').src = '';
        }

        // --- ä»¥ä¸‹ç‚ºä¹‹å‰çš„å·¥å…·å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        
        function updateExternalLinks() {
            const isbn = document.getElementById('isbn').value.trim();
            const title = document.getElementById('title').value.trim();
            const container = document.getElementById('link-container');
            let keyword = isbn || title;

            if (keyword) {
                container.style.display = 'block';
                document.getElementById('link-books').href = `https://search.books.com.tw/search/query/key/${keyword}`;
                document.getElementById('link-momo').href = `https://m.momoshop.com.tw/search.momo?searchKeyword=${keyword}`;
                document.getElementById('link-taaze').href = `https://www.taaze.tw/rwd_search_result.html?keyType%5B%5D=0&keyword%5B%5D=${keyword}`;
                document.getElementById('link-google').href = `https://www.google.com/search?q=${keyword}`;
            } else {
                container.style.display = 'none';
            }
        }

        function lookupBookData(type) {
            let query = "";
            const msg = document.getElementById('api-message');
            
            if (type === 'isbn') {
                const val = document.getElementById('isbn').value.replace(/[- ]/g, '');
                if (!val) { msg.textContent = "è«‹è¼¸å…¥ ISBN"; msg.style.color = "red"; return; }
                query = `isbn:${val}`;
            } else {
                const val = document.getElementById('title').value.trim();
                if (!val) { msg.textContent = "è«‹è¼¸å…¥æ›¸å"; msg.style.color = "red"; return; }
                query = `intitle:${val}`;
            }

            msg.textContent = "ğŸ” è³‡æ–™æœå°‹ä¸­...";
            msg.style.color = "blue";

            fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1`)
                .then(r => r.json())
                .then(data => {
                    if (data.totalItems > 0) {
                        const info = data.items[0].volumeInfo;
                        
                        if(info.title) document.getElementById('title').value = info.title;
                        if(info.authors) document.getElementById('author').value = info.authors.join(', ');
                        if(info.publisher) document.getElementById('publisher').value = info.publisher;
                        if(info.description) document.getElementById('description').value = info.description;
                        
                        if (info.publishedDate) {
                            const parts = info.publishedDate.split('-');
                            document.getElementById('year').value = parts[0];
                            if (parts.length > 1) document.getElementById('month').value = parts[1];
                        }

                        if (info.imageLinks) {
                            let imgUrl = info.imageLinks.thumbnail || info.imageLinks.smallThumbnail;
                            imgUrl = imgUrl.replace('http://', 'https://');
                            document.getElementById('cover_url').value = imgUrl;
                            updatePreviewFromUrl();
                        }
                        
                        updateExternalLinks();
                        msg.textContent = "âœ… æˆåŠŸæ‰¾åˆ°è³‡æ–™ï¼";
                        msg.style.color = "green";
                    } else {
                        msg.textContent = "âš ï¸ æ‰¾ä¸åˆ°æ­¤æ›¸ï¼Œè«‹è©¦è©¦å¤–éƒ¨é€£çµã€‚";
                        msg.style.color = "#d9534f";
                        updateExternalLinks();
                    }
                })
                .catch(err => {
                    console.error(err);
                    msg.textContent = "âŒ æŸ¥è©¢éŒ¯èª¤";
                    msg.style.color = "red";
                });
        }

        let html5QrCode;
        function startScanner() {
            document.getElementById('reader-container').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                document.getElementById('isbn').value = txt; 
                stopScanner(); 
                lookupBookData('isbn');
                updateExternalLinks();
            });
        }
        function stopScanner() { 
            if(html5QrCode) html5QrCode.stop(); 
            document.getElementById('reader-container').style.display = 'none'; 
        }
        
        function handleEnter(e, type) {
            if(e.key === 'Enter') {
                e.preventDefault();
                lookupBookData(type);
            }
        }

        function updatePreviewFromUrl() {
            const url = document.getElementById('cover_url').value;
            const previewBox = document.getElementById('cover-preview');
            const img = document.getElementById('book-cover-img');
            document.getElementById('cover_file').value = "";
            if (url) { img.src = url; previewBox.style.display = 'block'; } 
            else { previewBox.style.display = 'none'; }
        }

        function updatePreviewFromFile(input) {
            const previewBox = document.getElementById('cover-preview');
            const img = document.getElementById('book-cover-img');
            if (input.files && input.files[0]) {
                document.getElementById('cover_url').value = "";
                const reader = new FileReader();
                reader.onload = function(e) { img.src = e.target.result; previewBox.style.display = 'block'; }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>
